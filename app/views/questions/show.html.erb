<script>
  function tr_arrow(p_idurl, weight)
  {
    var textWeight = " ";
    var textColor = "white";
    if (weight > 0) {
        textWeight = '+' + weight;
        textColor = "green";
    }
    if (weight < 0) {
        textWeight = weight;
        textColor = "red" ;
    }
    document.getElementById('weight_' + p_idurl).childNodes[0].nodeValue = textWeight  ;
    document.getElementById('weight_' + p_idurl).style.backgroundColor = textColor ;
   }

  function clean_up_arrows()
  {
      <%= @products.collect { |product| "clean_up_one_arrow('#{product.idurl}');"}.join(' ') %>
  }


  function clean_up_one_arrow(p_idurl)
  {
    document.getElementById('weight_' + p_idurl).childNodes[0].nodeValue = " "  ;
    document.getElementById('weight_' + p_idurl).style.backgroundColor = "white" ;
  }
</script>


<div class="pkz_box">
  <%= model_selector(@knowledge, :questions) %>

    <div class="pkz_main">

      <!-- question header -->
      <div style="width:100%; height:60px; margin-bottom:10px; padding:5px;">
          <div >

            <span title="this question was presented <%= @question.nb_presentation.round %> time among all users"><%= pluralize @question.nb_presentation.round, "presentation" %></span>,&nbsp;
            <span title="this question was skipped <%= "%d" % @question.nb_oo %> times by users">no-opinion=<%= "%d" % @question.nb_oo %> (<%= "%d" % (@question.proba_oo * 100) %>%)</span>,&nbsp;
            <span style="background-color:<%= @question.confidence < 1 ? 'orange' : 'green' %>;">confidence=<%= "%d" % (@question.confidence * 100) %>%</span>
            ,&nbsp;weight=<%= @question.weight %>
          </div>
          <div style="font-weight:bold; margin-top:10px;" title="<%= @question.idurl %>"><%= @question.label %></div>
      </div>

      <!-- xml description -->
      <div id="xml_content" style="display:none; clear:left;">
          <textarea id="inputfield" style="width:100%; height:300px; background-color:lightblue;"><%= @question.to_xml %></textarea>
          <script>
              var editor = CodeMirror.fromTextArea("inputfield", {
              parserfile: ["tokenizejavascript.js", "parsejavascript.js"],
              path: "/codemirror/js/",
              stylesheet: "/codemirror/css/jscolors.css" });
          </script>
      </div>

      <!-- choices -->
      <div style="width:100%; margin-bottom:5px; border-bottom:1px solid black; border-top:1px solid black;">
          <div>
            <%= pluralize @question.nb_choices, "choice" %>,&nbsp;
            <%= @question.is_choice_exclusive ? "exclusive" : "multiple" %>,&nbsp;
            pre-condition:<%= @question.precondition || 'none' %>,&nbsp;
            <%= link_to_function "toggle xml", "document.getElementById('xml_content').toggle();" %>
          </div>
          <table border=1 width=100%><tr>
          <% for choice in @question.choices %>
            <td style="background-color:lightblue;" valign="top" >
                <div style="width:100%; text-align:center; font-weight:bold; border-bottom:1px solid black;" title="<%= choice.idurl %>">
                    <% if choice.url_description %>
                        <%= link_to(choice.label, "/domains/#{@knowledge.idurl}/questions/#{@question.idurl}/#{choice.url_description}") %>
                    <% else %>
                        <%= choice.label %>
                    <% end %>
                </div>
                <table><tr>
                  <td>
                    <img src="<%= "/domains/cell_phones/questions/q13_what_form_factor_are_you_looking_for/images/c36_candy_bar@main_image.jpg" %>" width="80" height=80 />
                  </td>
                  <td valign="top">
                    <div  style="font-size:90%;">
                      probability=<%= (choice.proba_ok * 100).round %>%
                      <br/>
                      nb selection=<%= choice.nb_ok %>
                      <br/>
                      <span onmouseover="<%= choice.generate_javascript_weights(@products) %>" onmouseout="clean_up_arrows();">
                        see weights...  
                      </span>
                      <br/>
                      <%= choice.question.nb_presentation %>
                    </div>
                  </td>
                </tr></table>
            </td>
          <% end %>
          </tr></table>

      </div>
      <div style="border-bottom:1px solid black;">
        discrimination=
        <%= render(:partial => "/questions/discrimination",
               :locals => {:discrimination => @question.discrimination(nil, @products_idurls)}) %>
      </div>
      <div style="-moz-column-count:3; clear:left;">
          <% for product in @products %>
              <div id="product_<%= product.idurl %>" style="width:100%;">
                <% distribution_proba_weight =  @products_distribution.get_distribution4product_idurl(product.idurl) %>
                <div style="display:inline-block;  text-align:right; width:30px;" title="<%= distribution_proba_weight.to_s  %>">
                    <%= "%+5.1f" % distribution_proba_weight.weighted_average %>
                </div>
                <div id="weight_<%= product.idurl %>" style="display:inline-block; width:30px; text-align:right;">&nbsp;</div>
                <span>&nbsp;<%= product.idurl %></span>


              </div>
          <% end %>
       </div>

    </div>

</div>
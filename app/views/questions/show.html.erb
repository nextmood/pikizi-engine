<script>
  function tr_arrow(p_idurl, weight)
  {
    var textWeight = " ";
    var textColor = "white";
    if (weight > 0) {
        textWeight = '+' + weight;
        textColor = "green";
    }
    if (weight < 0) {
        textWeight = weight;
        textColor = "red" ;
    }
    document.getElementById('weight_' + p_idurl).childNodes[0].nodeValue = textWeight  ;
    document.getElementById('weight_' + p_idurl).style.backgroundColor = textColor ;
   }

  function clean_up_arrows()
  {
      <%= @products.collect { |product| "clean_up_one_arrow('#{product.idurl}');"}.join(' ') %>
  }


  function clean_up_one_arrow(p_idurl)
  {
    document.getElementById('weight_' + p_idurl).childNodes[0].nodeValue = " "  ;
    document.getElementById('weight_' + p_idurl).style.backgroundColor = "white" ;
  }
</script>


<div class="pkz_box">
  <%= model_selector(@knowledge, :questions) %>

    <div class="pkz_main">

      <!-- question header -->
      <div style="width:100%; height:100px; background-color:yellow; margin-bottom:10px;">
        <div style="float: left; width: 100px;" >
            <img src='/domains/cell_phones/questions/q1_do_you_have_a_favorite_brand/images/c1_nokia@main_image_912.jpg' width="100" height=100 />
        </div>
        <div style="float: left; width: 800px; margin:10px;" >
          <div>
            <%= pluralize @question.nb_presentation.round, "presentation" %>,&nbsp;
            no-opinion=<%= "%d" % @question.nb_oo %> (<%= "%d" % (@question.proba_oo * 100) %>%),&nbsp;
            <span style="background-color:<%= @question.confidence < 1 ? 'orange' : 'green' %>;">confidence=<%= "%d" % (@question.confidence * 100) %>%</span>
          </div>
          <div style="font-weight:bold;" title="<%= @question.idurl %>"><%= @question.label %></div>
        </div>
      </div>

      <!-- xml description -->
      <div id="xml_content" style="display:none; clear:left;">
          <textarea id="inputfield" style="width:100%; height:300px; background-color:lightblue;"><%= @question.to_xml %></textarea>
          <script>
              var editor = CodeMirror.fromTextArea("inputfield", {
              parserfile: ["tokenizejavascript.js", "parsejavascript.js"],
              path: "/codemirror/js/",
              stylesheet: "/codemirror/css/jscolors.css" });
          </script>
      </div>

      <!-- choices -->
      <% width_choice = 190 %>
      <div style="width:<%= width_choice * @question.nb_choices %>px; height:80px; clear:left; margin-bottom:10px;">
          <div>
            <%= pluralize @question.nb_choices, "choice" %>,&nbsp;
            <%= @question.is_choice_exclusive ? "exclusive" : "multiple" %>,&nbsp;
            pre-condition:<%= @question.precondition || 'none' %>,&nbsp;
            <%= link_to_function "toggle xml", "document.getElementById('xml_content').toggle();" %>
          </div>
          <% for choice in @question.choices %>
            <div style="float: left; width: <%= width_choice - 6 %>px; background-color:lightblue; margin:2px; border:1px solid black;">
                <div style="width:100%; text-align:center; font-weight:bold; border-bottom:1px solid black;" title="<%= choice.idurl %>">
                  <%= choice.label %>
                </div>
                <div style="float: left; width: 80px; " >
                  <img src="<%= "/domains/#{@knowledge.idurl}/questions/#{@question.idurl}/#{choice.url_image}" %>" width="80" height=80 />
                </div>
                <div style="float: left; width: 100px;  margin-left:2px; ">

                  <div>
                    <%= link_to("...", "/domains/#{@knowledge.idurl}/questions/#{@question.idurl}/#{choice.url_description}") if choice.url_description %>
                  </div>
                  <div  style="font-size:90%;">
                    ok=<%= "%d" % choice.nb_ok %> (<%= "%d" % (choice.proba_ok * 100) %>%)
                    <img src='/images/icons/play.png' onmouseover="<%= choice.generate_javascript_weights(@products) %>" onmouseout="clean_up_arrows();" />
                  </div>
                </div>
            </div>
          <% end %>

      </div>

      <div style="-moz-column-count:3; clear:left;">
          <% for product in @products %>
              <div id="product_<%= product.idurl %>" style="width:100%;">
                <% product_probas = (@hash_product_proba[product.idurl] || []) %>
                <div style="display:inline-block;  text-align:right; width:30px;" title="<%= product_probas.join(', ')  %>">
                    <%= "%+5.1f" % Distribution.weighted_average(product_probas) %>
                </div>
                <div id="weight_<%= product.idurl %>" style="display:inline-block; width:30px; text-align:right;">&nbsp;</div>
                <span>&nbsp;<%= product.idurl %></span>


              </div>
          <% end %>
       </div>

    </div>

</div>